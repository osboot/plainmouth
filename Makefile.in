# SPDX-License-Identifier: GPL-3.0-or-later

PACKAGE_NAME    := @PACKAGE_NAME@
PACKAGE_VERSION := @PACKAGE_VERSION@

VERBOSE ?= $(V)
Q = $(if $(VERBOSE),,@)

PROGS =
PLUGINS =
GARBAGE =

bindir     = @bindir@
libdir     = @libdir@
libexecdir = @libexecdir@
pluginsdir = @libexecdir@/@PACKAGE_NAME@

PLUGINSDIR := $(CURDIR)/plugins

PTHREAD_CFLAGS := @PTHREAD_CFLAGS@
PTHREAD_LIBS   := @PTHREAD_LIBS@
NCURSES_CFLAGS := @NCURSES_CFLAGS@
NCURSES_LIBS   := @NCURSES_LIBS@
PANEL_CFLAGS   := @PANEL_CFLAGS@
PANEL_LIBS     := @PANEL_LIBS@

WARNINGS = \
	-Wall -W -Waggregate-return -Wconversion -Wdisabled-optimization \
	-Wmissing-declarations -Wmissing-format-attribute -Wmissing-noreturn \
	-Wmissing-prototypes -Wpointer-arith -Wredundant-decls -Wshadow \
	-Wstrict-prototypes -Wwrite-strings -Wmismatched-dealloc \
	#

CPPFLAGS = \
	-std=gnu99 -D_GNU_SOURCE -I$(CURDIR)/src \
	-DPACKAGE_NAME=\"$(PACKAGE_NAME)\" \
	-DPACKAGE_VERSION=\"$(PACKAGE_VERSION)\" \
	-DPLUGINSDIR=\"$(pluginsdir)\" \
	#

CFLAGS = -g -O0 -fPIC $(if $(DEBUG),-DDEBUG)
CFLAGS += $(PTHREAD_CFLAGS) $(NCURSES_CFLAGS) $(PANEL_CFLAGS)

override CFLAGS := $(WARNINGS) $(CFLAGS)
LDLIBS =

COMMON_SO   = libplainmouth.so
COMMON_SRC  = src/ipc.c src/request.c src/plugin.c \
	      src/warray.c \
	      src/widget.c \
	      src/widget_border.c \
	      src/widget_button.c \
	      src/widget_hbox.c \
	      src/widget_input.c \
	      src/widget_label.c \
	      src/widget_meter.c \
	      src/widget_select.c \
	      src/widget_spinbox.c \
	      src/widget_textview.c \
	      src/widget_tooltip.c \
	      src/widget_vbox.c \
	      src/widget_window.c \
	      #
COMMON_OBJ  = $(COMMON_SRC:.c=.o)
COMMON_LIBS = $(NCURSES_LIBS) $(PANEL_LIBS)
GARBAGE += $(COMMON_SO) $(COMMON_OBJ)

PROGS += plainmouthd
SRC_plainmouthd = src/plainmouthd.c
OBJ_plainmouthd = $(SRC_plainmouthd:.c=.o)
LIB_plainmouthd = $(PTHREAD_LIBS) $(NCURSES_LIBS) $(PANEL_LIBS) -L$(CURDIR) -lplainmouth
GARBAGE += plainmouthd $(OBJ_plainmouthd)

PROGS += plainmouth
SRC_plainmouth = src/plainmouth.c
OBJ_plainmouth = $(SRC_plainmouth:.c=.o)
LIB_plainmouth = -L$(CURDIR) -lplainmouth
GARBAGE += plainmouth $(OBJ_plainmouth)

PLUGINS = $(basename $(notdir $(wildcard src/plugins/*-main.c)))
PLUGINS := $(PLUGINS:-main=)
GARBAGE += $(PLUGINSDIR)

quiet_cmd = $(if $(VERBOSE),$(3),$(Q)printf "  %-08s%s\n" "$(1)" "$(2)"; $(3))

cmd_MKDIR = $(call quiet_cmd,MKDIR,$(patsubst $(CURDIR)/%,%,$(1))/,mkdir -p) -- $(1)
cmd_COPY = $(call quiet_cmd,COPY,$(patsubst $(CURDIR)/%,%,$(1)),cp -a) -- $(1) $(2)
cmd_LINK  = $(call quiet_cmd,LD,$(patsubst $(CURDIR)/%,%,$@),$(LINK.o)) $(1) $(LOADLIBES) $(LDLIBS) -o $@

.PHONY: all clean

TARGETS = \
	$(PROGS) \
	$(patsubst %,$(PLUGINSDIR)/%.so,$(PLUGINS)) \
	#

all: $(TARGETS)

clean:
	$(Q)$(RM) -r -- $(GARBAGE)

%.o: %.c
	$(call quiet_cmd,CC,$<,$(COMPILE.c)) $(CFLAGS) $(OUTPUT_OPTION) $<

$(COMMON_SO): Makefile $(COMMON_OBJ)
	$(call quiet_cmd,LD,$@,$(CC) -shared -o $@ $(COMMON_OBJ)) $(COMMON_LIBS)

plainmouthd: Makefile $(COMMON_SO) $(OBJ_plainmouthd)
	$(call cmd_LINK,$(OBJ_plainmouthd)) $(LIB_plainmouthd)

plainmouth:  Makefile $(COMMON_SO) $(OBJ_plainmouth)
	$(call cmd_LINK,$(OBJ_plainmouth)) $(LIB_plainmouth)

### Plugins

PLUGINS_SRC = $(wildcard src/plugins/*.c)
PLUGINS_OBJ = $(PLUGINS_SRC:.c=.o)
GARBAGE += $(PLUGINS_OBJ)

.PHONY: plugins-dest plugins-objs

plugins-dest: Makefile plugins-objs
	$(call cmd_MKDIR,$(PLUGINSDIR))

plugins-objs: $(PLUGINS_OBJ) $(COMMON_SO)

$(PLUGINSDIR)/%.so: plugins-dest plugins-objs
	$(call cmd_LINK,$(wildcard src/plugins/$*-*.o)) -shared -ldl $(NCURSES_LIBS) $(PANEL_LIBS) -L$(CURDIR) -lplainmouth

### Tests

.PHONY: check build-checks

VALGRIND = valgrind --error-exitcode=1 \
	--leak-check=full --time-stamp=yes --trace-children=yes \
	--track-fds=yes --track-origins=yes \
	#

TESTS := $(sort $(basename \
	$(wildcard tests/ipc/ipc_*.c) \
	$(wildcard tests/warray/warray_*.c) \
))

GARBAGE += $(TESTS) $(addsuffix .chk,$(TESTS)) $(addsuffix .log,$(TESTS))

.NOTINTERMEDIATE: $(TESTS)

build-checks: $(TESTS)

tests/ipc/%: tests/ipc/%.o src/ipc.o
	$(call cmd_LINK,$^)

tests/warray/%: tests/warray/%.o src/warray.o
	$(call cmd_LINK,$^)

tests/%.chk: tests/%
	@timeout -s KILL 5s $(VALGRIND) "$<" >"$<.log" 2>&1 && status='ok' || status='fail'; \
	flock -x $(CURDIR)/tests printf '%4s %s\n' "$$status" "$<"; \
	echo $$status > $@

check: $(addsuffix .chk,$(TESTS))
	@ret=0; ! grep -qsx fail -- $^ || ret=1; $(RM) -- $^; exit $$ret;

.PHONY: install

install: $(TARGETS)
	$(call cmd_MKDIR,$(DESTDIR)$(bindir))
	$(call cmd_MKDIR,$(DESTDIR)$(libdir))
	$(call cmd_MKDIR,$(DESTDIR)$(pluginsdir))
	$(call cmd_COPY,$(PROGS),$(DESTDIR)$(bindir))
	$(call cmd_COPY,$(COMMON_SO),$(DESTDIR)$(libdir))
	$(call cmd_COPY,$(PLUGINSDIR)/*.so,$(DESTDIR)$(pluginsdir))
